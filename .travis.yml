os: linux
dist: jammy
language: python
python:
- '3.9'
branches:
  only:
  - master
  - "/\\d+\\.\\d+\\.\\d+/"
jobs:
  include:
    - name: test
      install:
      - pip install tox
      - pip install setuptools --upgrade
      service:
      - docker
      script:
      - printenv
      - tox -e test
      - >
        docker run --rm
        -e SONARQUBE_SCANNER_PARAMS
        -e SONAR_TOKEN="${SONAR_TOKEN}"
        -v "`pwd`:/usr/src"
        sonarsource/sonar-scanner-cli
      - cat ${TRAVIS_HOME}/.sonarscanner/sonar-scanner/conf/sonar-scanner.properties
      - docker run --rm sonarsource/sonar-scanner-cli cat /opt/sonar-scanner/conf/sonar-scanner.properties
      addons:
        sonarcloud:
          token: ${SONAR_TOKEN}
    - name: flake8
      install:
      - pip install tox
      script:
      - tox -e flake8
    - stage: deploy
      if: branch ~= /\d+\.\d+\.\d+/
      name: pypi
      install: skip
      script: skip # skip test scripts
      deploy:
        provider: pypi
        skip_cleanup: true
        user: "__token__"
        password: ${PYPI_API_TOKEN}
        on:
          tags: true
          distributions: sdist bdist_wheel
